<!DOCTYPE html>
<html lang="en-us">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-89443615-1', 'auto');
  ga('send', 'pageview');

</script>

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Role语句 &middot; Ansible入门
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">



  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-89443615-1', 'auto');
    ga('send', 'pageview');

  </script>
</head>


  <body class="theme-base-08">

    <div class="sidebar">
    <div class="container sidebar-sticky">
        <div class="sidebar-about">
            <h2>
                <a href="/">
                    Ansible入门
                </a>
            </h2>
        </div>
        <nav class="sidebar-nav">
            <a class="sidebar-nav-item"
               href="mulu">目录</a>
            <ul>
    <li><a href="sheng_ming">声明</a></li>
    <li><a href="README">什么是Ansible</a></li>
    <li><a href="chapter1">Ansible的架构</a>
        <ul>
            <li><a href="ansible_towerde_jia_gou">Ansible Tower的架构</a></li>
        </ul>
    </li>
    <li><a href="ansibleshang_shou">Ansible上手</a>
        <ul>
            <li><a href="an_zhuang_ansile">安装Ansile</a></li>
            <li><a href="ansiblede_zhu_ji_mu_lu_guan_li">Ansible管理哪些主机</a></li>
            <li><a href="ansibleyong_ming_ling_guan_li_zhu_ji">Ansible用命令管理主机</a></li>
            <li><a href="ansibleyong_jiao_ben_guan_li_zhu_ji">Ansible用脚本管理主机</a></li>
            <li><a href="ansiblemo_kuai_module">Ansible模块Module</a></li>
        </ul>
    </li>
    <li><a href="ansiblejin_jie">Ansible进阶</a>
        <ul>
            <li><a href="ansiblede_pei_zhi">ansible的配置</a></li>
            <li><a href="zhu_ji_mu_lu_guan_li">Host Inventory</a>
                <ul>
                    <li><a href="zhu_ji_mu_lu_fen_zu">远程主机的分组</a></li>
                    <li><a href="zhi_ding_lian_jie_de_can_shu">远程主机的连接参数和变量</a></li>
                    <li><a href="fen_zu_guan_li_wen_jian">按目录结构存储变量</a></li>
                </ul>
            </li>
            <li><a href="playbook">Ansible的脚本(Playbook)</a>
                <ul>
                    <li><a href="playbookji_ben_yu_fa">Playbook基本语法</a>
                        <ul>
                            <li><a href="zhu_ji_he_yong_hu">主机和用户(hosts&amp;user)</a></li>
                            <li><a href="tasks">执行的任务(Tasks)</a></li>
                            <li><a href="handler">响应事件(Handler)</a></li>
                        </ul>
                    </li>
                    <li><a href="bian_liang">变量</a>
                        <ul>
                            <li><a href="playbookzhong_shi_yong_bian_liang">Playbook中使用的变量</a></li>
                            <li><a href="zhu_ji_de_xi_tong_bian_liang">主机的系统变量(facts)</a></li>
                            <li><a href="zhu_ce_bian_liang">把运行结果当做变量使用</a></li>
                            <li><a href="tamplatezhong_shi_yong_bian_liang">文件模板中使用的变量</a></li>
                            <li><a href="yong_ming_ling_xing_chuan_di_can_shu">用命令行传递参数</a></li>
                        </ul>
                    </li>
                    <li><a href="includeyu_ju">重用playbook(include语句)</a></li>
                    <li><a href="roleyu_ju">playbook的“函数"(role语句)</a></li>
                    <li><a href="tiao_jian_xuan_ze">条件语句when</a></li>
                    <li><a href="loopxun_huan">循环语句loop</a></li>
                    <li><a href="blockkuai">块语句block</a></li>
                </ul>
            </li>
            <li><a href="mo_kuai_modules">更多的Ansible模块(Extra Modules)</a>
                <ul>
                    <li><a href="modulesde_fen_lei">Modules的分类</a></li>
                    <li><a href="extra_modulede_shi_yong_fang_fa">Extra module的使用方法</a></li>
                    <li><a href="ming_ling_xing_cha_kan_module_de_yong_fa">命令行查看module的用法</a></li>
                </ul>
            </li>
            <li><a href="zui_jia_shi_yong_fang_fa">最佳使用方法</a></li>
        </ul>
    </li>
    <li><a href="tui_jian_de_can_kao_zi_liao">推荐的参考资料</a>
        <ul>
            <li><a href="yamlyu_fa_ji_chu">YAML语法基础</a></li>
            <li><a href="dai_xu">待续</a></li>
        </ul>
    </li>
    <li><a href="resources">《Ansible快速入门》实体书资源</a>
        <ul>
            <li><a href="link_resources">《Ansible快速入门》链接资源列表</a></li>
            <li><a href="errata">《Ansible快速入门》勘误表</a></li>
        </ul>
    </li>
</ul>

        </nav>
    </div>
    <div class="sidebar-foot">联系作者: shijingjing02@163.com</div>
</div>


    <div class="content container">
      <h1 id="role">Role语句</h1>

<p>比include更强大的代码重用机制。一个role可以包含vars_files, tasks, and handlers等等. 通常一个role定义了如何完成一个特定的功能,比如安装Webservers可以写成一个role, 安装Database可以写成一个role.</p>

<p>Ansible提供了一个分享role的平台, https://galaxy.ansible.com/, 在galaxy上可以找到别人写好的role.</p>

<h2 id="role-1">Role的目录结构</h2>

<p><strong>在ansible中,通过遵循特定的目录结构,就可以实现对role的定义.</strong></p>

<p>下面的目录结构定义了两个role：一个是common，另外一个是webservers。</p>

<p>在site.yml，调用了这两个role。</p>

<table>
    <tr>
        <td>
            role的目录结构
        </td>
        <td>
            site.yml中的使用
        </td>
    </tr>
    <tr>
        <td>
            <pre>
<code class="lang-yml">
site.yml
roles/
   common/  
     files/
     templates/
     tasks/
     handlers/
     vars/
     defaults/
     meta/
   webservers/
     files/
     templates/
     tasks/
     handlers/
     vars/
     defaults/
     meta/
</code>
</pre>
        </td>
        <td>
            <pre>
<code>
---
- hosts: webservers
  roles:
     - common
     - webservers
</code>
</pre>

        </td>
    </tr>
</table>

<h2 id="role-2">带参数的Role</h2>

<h3 id="role-3">定义带参数的role</h3>

<p>定义一个带参数的role,名字是role_with_var,那么目录结构为</p>

<div class="highlighter-rouge"><pre class="highlight"><code>main.yml
roles
 role_with_var
   tasks
     main.yml
</code></pre>
</div>

<p>在roles/rolw_with_var/tasks/main.yml中,直接使用定义的变量就可以了</p>

<div class="highlighter-rouge"><pre class="highlight"><code>---
- name: use param
 debug: msg=""

</code></pre>
</div>
<p>### 使用带参数的role</p>

<p>那么在main.yml就可以用如下的方法使用role_with_var</p>

<div class="highlighter-rouge"><pre class="highlight"><code>---

- hosts: webservers
  roles:
    - { role: role_with_var, param: 'Call some_role for the 1st time' }
    - { role: role_with_var, param: 'Call some_role for the 2nd time' }
</code></pre>
</div>

<h3 id="section">指定默认的参数</h3>

<p>指定默认参数后,如果在调用时传参数了,那么就使用传入的参数值.如果调用的时候没有传参数,那么就使用默认的参数值.</p>

<p>指定默认参数很简单,以上面的role_with_var为例</p>

<div class="highlighter-rouge"><pre class="highlight"><code>main.yml
roles:
  role_with_var
    tasks
      main.yml
    vars
      main.yml
</code></pre>
</div>
<p>在roles/role_with_var/vars/main.yml中,使用yml的字典定义语法定义param的值,如下:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>param: "I am the default value"
</code></pre>
</div>

<p>这样在main.yml中,下面两种调用方法都可以</p>

<div class="highlighter-rouge"><pre class="highlight"><code>---

- hosts: webservers
  roles:
    - role_with_var
    - { role: role_with_var, param: 'I am the value from external' }

</code></pre>
</div>
<p>更多的例子在https://github.com/shijingjing1221/ansible-first-book-examples/blob/master/role_vars.yml 中</p>

<h2 id="section-1">与条件语句一起执行</h2>

<p>下面的例子中,some_role只有在RedHat系列的server上才执行.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>---

- hosts: webservers
  roles:
    - { role: some_role, when: "ansible_os_family == 'RedHat'" }

</code></pre>
</div>

<h2 id="section-2">执行顺序</h2>

<p>pre_tasks &gt; role &gt; tasks &gt; post_tasks</p>

<div class="highlighter-rouge"><pre class="highlight"><code>---

- hosts: vm-rhel7-1
  user: root

  pre_tasks:
    - name: pre
      shell: echo 'hello'

  roles:
    - { role: some_role }

  tasks:
    - name: task
      shell: echo 'still busy'

  post_tasks:
    - name: post
      shell: echo 'goodbye'
</code></pre>
</div>

<p>看例子！！！</p>


    </div>

  </body>
</html>
