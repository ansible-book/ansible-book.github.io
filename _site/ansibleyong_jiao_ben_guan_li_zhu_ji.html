<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
       &middot; Ansible入门
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">



  <!-- Google Analytics -->
  <script>
    // (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    // (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    // m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    // })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    // ga('create', 'UA-146052-15', 'getpoole.com');
    // ga('send', 'pageview');
  </script>
</head>


  <body class="theme-base-08">

    <div class="sidebar">
    <div class="container sidebar-sticky">
        <div class="sidebar-about">
            <h2>
                <a href="/">
                    Ansible入门
                </a>
            </h2>
        </div>
        <nav class="sidebar-nav">
            <a class="sidebar-nav-item"
               href="/">目录</a>
            <ul>
    <li><a href="sheng_ming">声明</a></li>
    <li><a href="README">什么是Ansible</a></li>
    <li><a href="chapter1">Ansible的架构</a>
        <ul>
            <li><a href="ansible_towerde_jia_gou">Ansible Tower的架构</a></li>
        </ul>
    </li>
    <li><a href="ansibleshang_shou">Ansible上手</a>
        <ul>
            <li><a href="an_zhuang_ansile">安装Ansile</a></li>
            <li><a href="ansiblede_zhu_ji_mu_lu_guan_li">Ansible管理哪些主机</a></li>
            <li><a href="ansibleyong_ming_ling_guan_li_zhu_ji">Ansible用命令管理主机</a></li>
            <li><a href="ansibleyong_jiao_ben_guan_li_zhu_ji">Ansible用脚本管理主机</a></li>
            <li><a href="ansiblemo_kuai_module">Ansible模块Module</a></li>
        </ul>
    </li>
    <li><a href="ansiblejin_jie">Ansible进阶</a>
        <ul>
            <li><a href="ansiblede_pei_zhi">ansible的配置</a></li>
            <li><a href="zhu_ji_mu_lu_guan_li">Host Inventory</a>
                <ul>
                    <li><a href="zhu_ji_mu_lu_fen_zu">远程主机的分组</a></li>
                    <li><a href="zhi_ding_lian_jie_de_can_shu">远程主机的连接参数和变量</a></li>
                    <li><a href="fen_zu_guan_li_wen_jian">按目录结构存储变量</a></li>
                </ul>
            </li>
            <li><a href="playbook">Ansible的脚本(Playbook)</a>
                <ul>
                    <li><a href="playbookji_ben_yu_fa">Playbook基本语法</a>
                        <ul>
                            <li><a href="zhu_ji_he_yong_hu">主机和用户(hosts&amp;user)</a></li>
                            <li><a href="tasks">执行的任务(Tasks)</a></li>
                            <li><a href="handler">响应事件(Handler)</a></li>
                        </ul>
                    </li>
                    <li><a href="bian_liang">变量</a>
                        <ul>
                            <li><a href="playbookzhong_shi_yong_bian_liang">Playbook中使用的变量</a></li>
                            <li><a href="zhu_ji_de_xi_tong_bian_liang">主机的系统变量(facts)</a></li>
                            <li><a href="zhu_ce_bian_liang">把运行结果当做变量使用</a></li>
                            <li><a href="tamplatezhong_shi_yong_bian_liang">文件模板中使用的变量</a></li>
                            <li><a href="yong_ming_ling_xing_chuan_di_can_shu">用命令行传递参数</a></li>
                        </ul>
                    </li>
                    <li><a href="includeyu_ju">重用playbook(include语句)</a></li>
                    <li><a href="roleyu_ju">playbook的“函数"(role语句)</a></li>
                    <li><a href="tiao_jian_xuan_ze">条件语句when</a></li>
                    <li><a href="loopxun_huan">循环语句loop</a></li>
                    <li><a href="blockkuai">块语句block</a></li>
                </ul>
            </li>
            <li><a href="mo_kuai_modules">更多的Ansible模块(Extra Modules)</a>
                <ul>
                    <li><a href="modulesde_fen_lei">Modules的分类</a></li>
                    <li><a href="extra_modulede_shi_yong_fang_fa">Extra module的使用方法</a></li>
                    <li><a href="ming_ling_xing_cha_kan_module_de_yong_fa">命令行查看module的用法</a></li>
                </ul>
            </li>
            <li><a href="zui_jia_shi_yong_fang_fa">最佳使用方法</a></li>
        </ul>
    </li>
    <li><a href="tui_jian_de_can_kao_zi_liao">推荐的参考资料</a>
        <ul>
            <li><a href="yamlyu_fa_ji_chu">YAML语法基础</a></li>
            <li><a href="dai_xu">待续</a></li>
        </ul>
    </li>
</ul>
        </nav>
    </div>
    <div class="sidebar-foot">联系作者: shijingjing02@163.com</div>
</div>


    <div class="content container">
      <h1 id="ansible">Ansible用脚本管理主机</h1>

<p>只有脚本才可以重用，避免总敲重复的代码。Ansible脚本的名字叫Playbook，使用的是YAML的格式，文件 以yml结尾。</p>

<p>注解：YAML和JSON类似，是一种表示数据的格式。</p>

<h2 id="playbook">执行脚本playbook的方法</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>$ansible-palybook deploy.yml
</code></pre>
</div>

<h2 id="playbook-1">playbook的例子</h2>

<p>deploy.yml的功能为web主机部署apache, 其中包含以下部署步骤：</p>

<ol>
  <li>安装apache包；</li>
  <li>拷贝配置文件httpd，并保证拷贝文件后，apache服务会被重启；</li>
  <li>拷贝默认的网页文件index.html；</li>
  <li>启动apache服务；</li>
</ol>

<p>playbook deploy.yml包含下面几个关键字，每个关键字的含义：</p>

<ul>
  <li><strong>hosts</strong>：为主机的IP，或者主机组名，或者关键字all</li>
  <li><strong>remote_user</strong>: 以哪个用户身份执行。</li>
  <li><strong>vars</strong>： 变量</li>
  <li>
    <p><strong>tasks</strong>: playbook的核心，定义顺序执行的动作action。每个action调用一个ansbile module。</p>
  </li>
  <li>
    <blockquote>
      <p>action 语法： <code class="highlighter-rouge">module： module_parameter=module_value</code></p>
    </blockquote>
  </li>
  <li>
    <blockquote>
      <p>常用的module有yum、copy、template等，module在ansible的作用，相当于bash脚本中yum，copy这样的命令。下一节会介绍。</p>
    </blockquote>
  </li>
  <li><strong>handers</strong>： 是playbook的event，默认不会执行，在action里触发才会执行。多次触发只执行一次。</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>---
- hosts: web
  vars:
    http_port: 80
    max_clients: 200
  remote_user: root
  tasks:
  - name: ensure apache is at the latest version
    yum: pkg=httpd state=latest

  - name: Write the configuration file
    template: src=templates/httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf
    notify:
    - restart apache

  - name: Write the default index.html file
    template: src=templates/index.html.j2 dest=/var/www/html/index.html

  - name: ensure apache is running
    service: name=httpd state=started
  handlers:
    - name: restart apache
      service: name=httpd state=restarted

</code></pre>
</div>

<hr />

<p>不懂yml，没关系，上面的deploy.yml格式转化为json格式为：</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"web"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"vars"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"http_port"</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w">
      </span><span class="nt">"max_clients"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nt">"remote_user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"root"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"tasks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ensure apache is at the latest version"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"yum"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pkg=httpd state=latest"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Write the configuration file"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"template"</span><span class="p">:</span><span class="w"> </span><span class="s2">"src=templates/httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"notify"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"restart apache"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Write the default index.html file"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"template"</span><span class="p">:</span><span class="w"> </span><span class="s2">"src=templates/index.html.j2 dest=/var/www/html/index.html"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ensure apache is running"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"service"</span><span class="p">:</span><span class="w"> </span><span class="s2">"name=httpd state=started"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nt">"handlers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"restart apache"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"service"</span><span class="p">:</span><span class="w"> </span><span class="s2">"name=httpd state=restarted"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>
</div>

<p>提供json和yml互转的在线网站： <a href="http://www.json2yaml.com/">http://www.json2yaml.com/</a></p>


    </div>

  </body>
</html>
